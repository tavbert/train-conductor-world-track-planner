<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TCW Map</title>
  <style>
    .highlight { background-color: yellow !important; color: #000 !important; }
    .highlightTie { background-color: orange !important; color: #000 !important; }

    .grass { background-color: #669856; }
    .darkgrass { background-color: #5c8d5d; }
    .forest { background-color: #6f7223; }
    .fallforest { background-color: #867613; }
    .mountain { background-color: #838579; }
    .tallmountain { background-color: #6b767a; }
    .water { background-color: #3d5d71; }
    .darkwater { background-color: #334a5a; }
    .swamp { background-color: #354526; }
    .cloud { background-color: #aab; }
    .desert { background-color: rgb(151, 116, 73); }
    .deepdesert { background-color: rgb(195, 149, 50); }

    #grimsby, #hamburg, #rotterdam, #stuttgart, #dijon, #bucharest, #marseille {
      background-color: gray;
      border: 2px solid #111;
      width: 14px;
      height: 14px;
    }

    #gothenburg { background-color: #cc786d; }
    #edinburgh { background-color: #c73765; }
    #belfast { background-color: #4c2f1f; }
    #copenhagen { background-color: #bb6339; }
    #amsterdam { background-color: #4e368e; }
    #london { background-color: #9d6abb; }
    #berlin { background-color: #87263b; }
    #bruges { background-color: #cb494c; }
    #cologne { background-color: #235720; }
    #warsaw { background-color: #415388; }
    #mons { background-color: #1e6ec4; }
    #bastei { background-color: #693351; }
    #paris { background-color: #c96e9b; }
    #prague { background-color: #465e07; }
    #budapest { background-color: #696256; }
    #matterhorn { background-color: #383833; }
    #lyon { background-color: #774e29; }
    #bernina { background-color: #a6171b; }
    #millau { background-color: #005865; }
    #verdon { background-color: #40af59; }
    #mostar { background-color: #00b6c1; }
    #florence { background-color: #e85e36; }
    #porto { background-color: #063970; }
    #madrid { background-color: #753b8c; }
    #rome { background-color: #082647; }
    #cappadocia { background-color: #966126; }
    #meteora { background-color: blue; }
    #damascus { background-color: #0c410f; }

    .tile { width: 16px; height: 16px; border: 1px solid #666; cursor: grab; }

    .cell {
      width: 16px;
      height: 16px;
      border: 1px solid #999;
      color: #fff;
      font-size: 9px;
      font-weight: bold;
      align-items: center;
      display: flex;
      justify-content: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(61, 16px);
      grid-template-rows: repeat(56, 16px);
      gap: 1px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .counttile { width: 16px; height: 16px; border: 1px solid #666; }

    body { margin: 0; height: 100vh; gap: 3px; font-family: sans-serif; }

    .cell img { width: 100%; height: 100%; object-fit: contain; cursor: pointer; }

    .tiles { display: flex; gap: 10px; justify-content: center; }

    .button-bar { display: flex; gap: 8px; padding: 4px; }
    .button-bar button {
      padding: 6px 12px;
      border: 1px solid #888;
      background: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
    }

    .side-list { padding: 10px; display: flex; flex-direction: column; gap: 12px; }
    .countrow { display: flex; align-items: center; gap: 10px; }
    .main-picture { padding: 10px; align-items: center; justify-content: center; background: #fafafa; }
    .bottom-buttons { display: flex; justify-content: center; gap: 10px; }
    table { width: 100%; border-collapse: collapse; border: 0; }
    .tilechoice { background: #ccc; }
  </style>
</head>
<body>

<table style="width: 100%">
  <tr>
    <td style="width:250px;">
      <div class="button-bar">
        <button id="exportBtn">Export Grid</button>
        <button id="importBtn">Load Grid</button>
        <input type="file" id="importFile" accept=".json" style="display:none">
      </div>
    </td>
    <td rowspan="2">
      <div class="main-picture">
        <div class="grid" id="grid"></div>
      </div>
    </td>
  </tr>
  <tr>
    <td rowspan="2">
      <div class="side-list">
        <p class="countrow">Track Count</p>
        <div class="countrow"><img id="UD" class="counttile" src="./images/UD.png"><span id="countUD">0</span></div>
        <div class="countrow"><img id="LR" class="counttile" src="./images/LR.png"><span id="countLR">0</span></div>
        <div class="countrow"><img id="NE" class="counttile" src="./images/NE.png"><span id="countNE">0</span></div>
        <div class="countrow"><img id="SE" class="counttile" src="./images/SE.png"><span id="countSE">0</span></div>
        <div class="countrow"><img id="SW" class="counttile" src="./images/SW.png"><span id="countSW">0</span></div>
        <div class="countrow"><img id="NW" class="counttile" src="./images/NW.png"><span id="countNW">0</span></div>
        <div class="countrow"><img id="UL" class="counttile" src="./images/UL.png"><span id="countUL">0</span></div>
        <div class="countrow"><img id="UR" class="counttile" src="./images/UR.png"><span id="countUR">0</span></div>
        <div class="countrow"><img id="RU" class="counttile" src="./images/RU.png"><span id="countRU">0</span></div>
        <div class="countrow"><img id="RD" class="counttile" src="./images/RD.png"><span id="countRD">0</span></div>
        <div class="countrow"><img id="DR" class="counttile" src="./images/DR.png"><span id="countDR">0</span></div>
        <div class="countrow"><img id="DL" class="counttile" src="./images/DL.png"><span id="countDL">0</span></div>
        <div class="countrow"><img id="LD" class="counttile" src="./images/LD.png"><span id="countLD">0</span></div>
        <div class="countrow"><img id="LU" class="counttile" src="./images/LU.png"><span id="countLU">0</span></div>
        <div class="countrow"><img id="LRU" class="counttile" src="./images/LRU.png"><span id="countLRU">0</span></div>
        <div class="countrow"><img id="UDR" class="counttile" src="./images/UDR.png"><span id="countUDR">0</span></div>
        <div class="countrow"><img id="LRD" class="counttile" src="./images/LRD.png"><span id="countLRD">0</span></div>
        <div class="countrow"><img id="UDL" class="counttile" src="./images/UDL.png"><span id="countUDL">0</span></div>
        <div class="countrow">Total: <span id="countTOT">0</span></div>
      </div>
    </td>
  </tr>
  <tr>
    <td>
      <div class="bottom-buttons">
        <img src="./images/UD.png" class="tile tilechoice" draggable="true" data-tile="UD">
        <img src="./images/LR.png" class="tile tilechoice" draggable="true" data-tile="LR">
        <img src="./images/NE.png" class="tile tilechoice" draggable="true" data-tile="NE">
        <img src="./images/SE.png" class="tile tilechoice" draggable="true" data-tile="SE">
        <img src="./images/SW.png" class="tile tilechoice" draggable="true" data-tile="SW">
        <img src="./images/NW.png" class="tile tilechoice" draggable="true" data-tile="NW">
        <img src="./images/UL.png" class="tile tilechoice" draggable="true" data-tile="UL">
        <img src="./images/UR.png" class="tile tilechoice" draggable="true" data-tile="UR">
        <img src="./images/RU.png" class="tile tilechoice" draggable="true" data-tile="RU">
        <img src="./images/RD.png" class="tile tilechoice" draggable="true" data-tile="RD">
        <img src="./images/DR.png" class="tile tilechoice" draggable="true" data-tile="DR">
        <img src="./images/DL.png" class="tile tilechoice" draggable="true" data-tile="DL">
        <img src="./images/LD.png" class="tile tilechoice" draggable="true" data-tile="LD">
        <img src="./images/LU.png" class="tile tilechoice" draggable="true" data-tile="LU">
        <img src="./images/LRU.png" class="tile tilechoice" draggable="true" data-tile="LRU">
        <img src="./images/UDR.png" class="tile tilechoice" draggable="true" data-tile="UDR">
        <img src="./images/LRD.png" class="tile tilechoice" draggable="true" data-tile="LRD">
        <img src="./images/UDL.png" class="tile tilechoice" draggable="true" data-tile="UDL">
      </div>
    </td>
  </tr>
</table>

<script>
// Grid terrain data (61 cols x 56 rows) - encoded: w=water, W=darkwater, g=grass, G=darkgrass, f=forest, F=fallforest, m=mountain, M=tallmountain, s=swamp, c=cloud
const GRID_DATA = [


  "WWWWWwwMMMmmGwwwwwwwwwwwwwwwwwwwwFFFffwWWWccccccccccccccccccc",
  "WWWWwwwwmMMFGwwwwwwwwwwwwwwwwwGGGGFGwwwWWWccccccccccccccccccc",
  "WWWwwwwmfmmwwwwwwwwwwwwwwwwGwwwGGwfGwGwWWWccccccccccccccccccc",
  "wwwwwwwfmffwwwwwwwwwwwwwwwwGwwwGfGGGwGwWWcccccccccccccccccccc",
  "wwGmGwwwmmFmwwwwwwwwwwwwwwGGGwwwGGGGwwwWWcccwGccccccccccccccc",
  "wFmFwwwwwwmFwwwwwwwwwwwwwwGfwwwwwGwwwwwccGGGGGGfccccccccccccc",
  "mfggGwwwwmFFGwwwwwwwwwwwwwGwgwgwwwwwwwcccGGGfFcFFcccccccccccc",
  "MfggwwwwwffFGgwwwwwwwwwwwwGwwwwwwwwwwwwcwGGGGFFFcfccccccccccc",
  "fgGGwwwwmfFgwwwwwwwwwwwwwwggwwwwwwwwggwwsGGGGfFFFcFcccccccccc",
  "fGgmwwwwmfGgggwwwwwwwwwFGgwgfwgGwwwGFfggGGGGGFFFFFFcccccccccc",
  "GGGGwwwmGGGGGgggwwwwwwGFFggGfffgGwGffFFggGGGGFFffcccccccccccc",
  "GwwwwwfmmGGgggggwwwwwgggFFFfGfGGfGffGGFfggggGffFffcfccccccccc",
  "wwwwwwwwGGGggwwwwwwwwGgfGFfGfGGwgGgfgfFfFgggGGfffcFfccccccccc",
  "wwwwwwGGGGgggggwwwwgwgggGFfGGGGGggggffffgfgggfGfffFcfcccccccc",
  "wwwwGGmgwwwwwwwwwwGgggggggGGGGGfffGfffffffgggGFffffffcccccccc",
  "wwwwwwwwwwwwwwwwGwgggGggwgGGfFFffFFffffffggwgGGfGGfffcccccccc",
  "wwwwwwwwwwwwwwwwGgggggGggGGfFfffFFfFFfFffggggGFGGGGGfcccccccc",
  "wwwwwwwwwwwwwwwGggggwgggggGGfffGGfFfFfffgggGGGGgGGGGGGccccccc",
  "wwwwwwwwwwGwwGfgGgggGgfGgGffggffFGffmFffGGGGgGGgggGGGGccccccc",
  "cwwwwcwwwwGGggggGGgGgfGgggfgggfGfmwmFmffGGGfGGGfgGGgggccccccc",
  "cccwcccGwwGffggggggfGgGFGfgGgwwmFfgmfmmffffffFGGGGGGGGccccccc",
  "ccccccccGgGFFGGwgffffGfffGgwgGfmGgmffwmmMmFFFFffGGGGGGccccccc",
  "cccwcccwggGfgfGggGfffFFffFFGGfGGggfffmFmMMmmfFFfGGwGGcccccccc",
  "cwwwwcwwwgGGGFGfgggGfFfFFFFFFGGfgFmFmfffmmmmmMmfGGgccGccccccc",
  "WWWwwwwwwGGgGffggGfggffFGFFFGfFfFFmFFfffFFffFmMmfGgwwcGcccccc",
  "WWWWwwwwwGwggGGgfGgwgfFFGGFGffFFFFFMmffGGffGFFFMmfGgwGgGccccc",
  "WcWWwwwwwwgGgGGggggggFFGgGfwGfFFFmmMFfGGGwGGfGFFmfGGgwGGccccc",
  "cWWWWwwwwwGGgggGgGGGfFFgGfGfwFmMmmMFFFffGwGGfGGFMmGGGGGGGcccc",
  "cWWWWwwwwwGGgggfGFfffFfwwmmMmMmMMFMMmFfGwGGGFfmFMmGGGGGgGcccc",
  "WWWWWwwwwwfFGfffffffffFFMMwMMMMMMFFmFFfGGGmFFmmmmmGGGGGcGcccc",
  "WWWWWwwwwwGFFfFFFGfFwFFFFfGmMMMmMMmFMFffGGGFmmmMmfGGfGGwgGccc",
  "WWWWWWwwwwffFGFFGGffGffFMMMMMmwMmmmmmmfffGGmmmfffGGggwwcgcwcc",
  "wwwwWWWwwGGFFfmGFfffmfFmMMMwFwGmmmFFFmmfFfmmmffwffGgwwcccgfwf",
  "wwwwWWWWwFfFFFmwmfffmfFMmFFFGGwFFGwfFFmmfFfmmmfGGGggwwwcgwcGf",
  "GGwwwwwwwmFFffFGmfFmmmfmMfGGGGGGGGwffwFmMffFfmmfGGgwwwWWWWwwf",
  "mFFMmmFmmMmFFfffffFmGfFFmmFmfGgggwwwwFFmmmffFFmfGmgwwWWWWWWWW",
  "GmFFMmFFGMMFFFffFfFFFfwFgwwmmmmgwwwwwwFfwmmmmffmmffwWWWWWWWWW",
  "GfmFFFmmFMMMMFFfGwGfFfgwwwwwgwmFFwwwwwfGGmmfffmmmmfwWWWWWWWWW",
  "fmFGGFMmFFmMMMMwwwwwffwwwwwwfFFmFFwwwwwFFmMfmmmmmffwWWWgffwww",
  "fffgfFFmGGGmmMmwwwwwwwwWWwwwggFFmFfwwwwwffmffFfmmfffwwgfmmFFw",
  "wmfffMMFGGGGGmmwwwwwwwWWWwwwwgfFmmFfwwwwwfmmMFffgfffggfmmmmmF",
  "FfGfmMMGFfGGGGwwwwwWWWWWWwMwwwfmmmmFfmwwwwfmFFmffggwwwwmfGGmm",
  "ffGmmfwffmGGGwwwwwWWWWWWWwMwwWwwwmmFfgwwwwgmFffgwwwmmfmffGmGG",
  "fFfGGfFfFmMGwwwwwWWWWWWWwwwwWWWWwwmmfggGwwgFmgwwgwffmmGfmmmGm",
  "FfffFfFfFmmwwwGGWWWWWWWWwffwWWWWWWwmmfggGwwGmggwwwffmmffwGFGm",
  "GfFfffffFffwwwWWcWWWWWWWwfMwWWWWWWwwGfwwGwwwmwgwwgwffmGffFFmG",
  "GfFFfGGGffmmwWWWWWcWWcWWwfMwWWWWWWWwmMwwwwwwmffGwwgwmfGGmmmwG",
  "fffffffffmmwwWWWWcccWWWWwGwWWWWWWWWwmfwWWWwwwmfwGwwwMGfGmmGGG",
  "ffggGffmMmGwwWWWWWcWWWWWwwWWWWWWWWwwmWWWWWWwGwwGwwgwgmFFmGmGd",
  "wwwFGmmMMwwWWWWWWWWWcccccWWcWwwwGGMmWWWWcWWWwGmwgwwwmFggFmmGG",
  "WWwwGGWWWWWWWWWWWcWccccccccWWwwwwfGWWWWcWWWWWwFwwwgwfmwFwdddd",
  "WWWwWWWWWWWWWWWWWWWcccccccccwwwwwwwWWWWWcWWWWWwwwwwwcwwWWGddd",
  "WWwwdWWWWWWWWWwwwwccccccccccccwwwwwWWcccWWWWWWWwwcggwwGGwGddd",
  "WwwddmwwwwddddmmddcccccccccccccccccccccccccWWWWWWWcccWwWWGddd",
  "cwdmdmdddddddddddcccccccccccccccccccccccccccccccccccWcWWWGddD",
  "wdddmdddmdddDcDDcccccccccccccccccccccccccccccccccccccWWWWGdDD"
];

// Cities: { id: { x, y, label, nodrop } }
const CITIES = {
  gothenburg: { x: 31, y: 1, label: "Go", nodrop: true },
  edinburgh: { x: 12, y: 4, label: "Ed", nodrop: true },
  belfast: { x: 5, y: 6, label: "Bf", nodrop: true },
  copenhagen: { x: 31, y: 6, label: "Cp", nodrop: true },
  grimsby: { x: 13, y: 9, label: "Gr", nodrop: true },
  hamburg: { x: 27, y: 10, label: "Ha", nodrop: true },
  amsterdam: { x: 22, y: 11, label: "Am", nodrop: true },
  london: { x: 14, y: 13, label: "Ld", nodrop: true },
  berlin: { x: 32, y: 13, label: "Be", nodrop: true },
  rotterdam: { x: 21, y: 14, label: "Ro", nodrop: true },
  bruges: { x: 18, y: 16, label: "Br", nodrop: true },
  cologne: { x: 25, y: 16, label: "Co", nodrop: true },
  warsaw: { x: 44, y: 16, label: "Wa", nodrop: true },
  mons: { x: 21, y: 18, label: "Mo", nodrop: true },
  bastei: { x: 35, y: 20, label: "Ba", nodrop: true },
  paris: { x: 16, y: 22, label: "Pa", nodrop: true },
  stuttgart: { x: 28, y: 22, label: "St", nodrop: true },
  prague: { x: 38, y: 22, label: "Pr", nodrop: true },
  dijon: { x: 20, y: 26, label: "Di", nodrop: true },
  budapest: { x: 42, y: 27, label: "Bd", nodrop: true },
  matterhorn: { x: 27, y: 30, label: "Mt", nodrop: true },
  lyon: { x: 21, y: 31, label: "Ly", nodrop: true },
  bernina: { x: 31, y: 32, label: "Bn", nodrop: true },
  bucharest: { x: 48, y: 33, label: "Bc", nodrop: true },
  millau: { x: 16, y: 34, label: "Mi", nodrop: true },
  verdon: { x: 23, y: 37, label: "Ve", nodrop: true },
  mostar: { x: 41, y: 37, label: "Ms", nodrop: true },
  florence: { x: 30, y: 38, label: "Fl", nodrop: true },
  marseille: { x: 20, y: 39, label: "Ma", nodrop: true },
  porto: { x: 1, y: 41, label: "Po", nodrop: true },
  madrid: { x: 7, y: 43, label: "Md", nodrop: true },
  rome: { x: 33, y: 43, label: "Rm", nodrop: true },
  cappadocia: { x: 57, y: 45, label: "Ca", nodrop: true },
  meteora: { x: 46, y: 46, label: "Me", nodrop: true },
  damascus: { x: 60, y: 55, label: "Ds", nodrop: true }
};

const TERRAIN_MAP = {
  w: "water", W: "darkwater", g: "grass", G: "darkgrass",
  f: "forest", F: "fallforest", m: "mountain", M: "tallmountain",
  s: "swamp", c: "cloud", "-": "cloud", d: "desert", D: "deepdesert"
};

const COLS = 61, ROWS = 56;
let currentCell = null;

// Build city lookup by position
const cityByPos = {};
for (const [id, data] of Object.entries(CITIES)) {
  cityByPos[`${data.x}_${data.y}`] = { id, ...data };
}

// Generate grid
function generateGrid() {
  const grid = document.getElementById("grid");
  for (let y = 1; y <= ROWS; y++) {
    const rowData = GRID_DATA[y - 1];
    for (let x = 1; x <= COLS; x++) {
      const cell = document.createElement("div");
      const posKey = `${x}_${y}`;
      const city = cityByPos[posKey];

      if (city) {
        cell.id = city.id;
        cell.className = city.nodrop ? "cell nodrop" : "cell " + TERRAIN_MAP[rowData[x - 1]];
        cell.textContent = city.label;
        if (!city.nodrop) {
          cell.ondrop = drop;
          cell.ondragover = allowDrop;
        }
      } else {
        cell.id = `cell_${x}_${y}`;
        const terrain = TERRAIN_MAP[rowData[x - 1]] || "water";
        if (terrain === "cloud") {
          cell.className = "cell cloud nodrop";
        } else {
          cell.className = "cell " + terrain;
          cell.ondrop = drop;
          cell.ondragover = allowDrop;
        }
      }
      grid.appendChild(cell);
    }
  }
}

// Drag & Drop
function allowDrop(ev) { ev.preventDefault(); }

function drag(ev) {
  const target = ev.target;
  if (target.dataset.tile) {
    ev.dataTransfer.setData("tileSrc", target.src);
    ev.dataTransfer.setData("tileId", target.dataset.tile);
  } else {
    ev.dataTransfer.setData("tileSrc", target.src);
    ev.dataTransfer.setData("tileId", target.parentElement.dataset.tileId);
    ev.dataTransfer.setData("originalId", target.id);
  }
}

function drop(ev) {
  ev.preventDefault();
  const src = ev.dataTransfer.getData("tileSrc");
  const id = ev.dataTransfer.getData("tileId");
  const originalId = ev.dataTransfer.getData("originalId");
  const originalTile = document.getElementById(originalId);

  let targetCell = ev.target.classList.contains("cell") ? ev.target : ev.target.parentElement;
  if (!targetCell.classList.contains("cell")) return;

  if (originalTile) {
    delete originalTile.parentElement.dataset.tileId;
    originalTile.remove();
  }

  placeTile(targetCell, src, id, targetCell.firstChild);
}

function placeTile(cell, src, tileId, existing) {
  if (existing) existing.remove();

  const newTile = document.createElement("img");
  newTile.src = src;
  newTile.draggable = true;
  newTile.id = cell.id + "_t";
  newTile.addEventListener("contextmenu", e => {
    e.preventDefault();
    if (cell.firstChild) cell.firstChild.remove();
    delete cell.dataset.tileId;
    countTrack();
  });
  newTile.addEventListener("dragstart", drag);

  cell.dataset.tileId = tileId;
  cell.appendChild(newTile);
  countTrack();
}

// Track counting
const TRACK_TYPES = ["UD","LR","NE","NW","SE","SW","UL","UR","DL","DR","LU","LD","RU","RD","LRU","LRD","UDL","UDR"];

function countTrack() {
  const counts = { TOT: 0 };
  TRACK_TYPES.forEach(t => counts[t] = 0);

  document.querySelectorAll(".cell[data-tile-id]").forEach(cell => {
    counts.TOT++;
    counts[cell.dataset.tileId]++;
  });

  Object.entries(counts).forEach(([key, val]) => {
    const el = document.getElementById("count" + key);
    if (el) el.textContent = val;
  });
}

// Keyboard shortcuts
const KEY_MAP = {
  "1": "UD", "2": "LR", "3": "NE", "4": "SE", "5": "SW", "6": "NW",
  "7": "LRU", "8": "UDR", "9": "LRD", "0": "UDL",
  "q": "UL", "w": "UR", "e": "RU", "r": "RD", "t": "DR", "y": "DL", "u": "LD", "i": "LU"
};

document.addEventListener("keydown", e => {
  if (!currentCell || currentCell.classList.contains("nodrop")) return;
  const tileId = KEY_MAP[e.key];
  if (tileId) {
    const src = `./images/${tileId}.png`;
    placeTile(currentCell, src, tileId, currentCell.firstChild);
  }
});

// Hover tracking
document.addEventListener("DOMContentLoaded", () => {
  generateGrid();

  document.querySelectorAll(".cell").forEach(cell => {
    cell.addEventListener("mouseenter", () => { currentCell = cell; cell.classList.add("hovered"); });
    cell.addEventListener("mouseleave", () => { currentCell = null; cell.classList.remove("hovered"); });
    cell.addEventListener("contextmenu", e => e.preventDefault());
  });

  // Counter hover highlighting
  document.querySelectorAll(".countrow img").forEach(img => {
    img.addEventListener("mouseenter", () => {
      document.querySelectorAll(`[data-tile-id="${img.id}"]`).forEach(el => el.classList.add("highlight"));
    });
    img.addEventListener("mouseleave", () => {
      document.querySelectorAll(`[data-tile-id="${img.id}"]`).forEach(el => el.classList.remove("highlight"));
    });
  });

  // Tile palette drag
  document.querySelectorAll(".tilechoice").forEach(tile => {
    tile.addEventListener("dragstart", drag);
  });
});

// City highlight groups
const highlightGroups = {
  grimsby: ["london","edinburgh","belfast","amsterdam","bruges","paris","mons","cologne","copenhagen"],
  hamburg: ["amsterdam","copenhagen","berlin","cologne","gothenburg","mons","bruges","london","bastei"],
  rotterdam: ["amsterdam","mons","bruges","cologne","london","berlin","paris","copenhagen"],
  stuttgart: ["cologne","bastei","matterhorn","prague","mons","paris","berlin","bernina"],
  dijon: ["lyon","paris","mons","matterhorn","bruges","millau","verdon","cologne"],
  bucharest: ["mostar","budapest","meteora","bernina","warsaw","prague","cappadocia","florence","matterhorn"],
  marseille: ["verdon","lyon","millau","florence","matterhorn","madrid","rome","bernina"]
};

const highlightGroupsTie = {
  grimsby: [], hamburg: [],
  rotterdam: ["lyon","edinburgh"],
  stuttgart: ["lyon","bruges"],
  dijon: ["amsterdam","bernina"],
  bucharest: [],
  marseille: ["paris","porto"]
};

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".cell").forEach(cell => {
    cell.addEventListener("mouseenter", () => {
      const group = highlightGroups[cell.id];
      const tie = highlightGroupsTie[cell.id];
      if (group) {
        group.forEach(id => document.getElementById(id)?.classList.add("highlight"));
        tie?.forEach(id => document.getElementById(id)?.classList.add("highlightTie"));
      }
    });
    cell.addEventListener("mouseleave", () => {
      const group = highlightGroups[cell.id];
      const tie = highlightGroupsTie[cell.id];
      if (group) {
        group.forEach(id => document.getElementById(id)?.classList.remove("highlight"));
        tie?.forEach(id => document.getElementById(id)?.classList.remove("highlightTie"));
      }
    });
  });
});

// Export/Import
document.getElementById("exportBtn").addEventListener("click", () => {
  const state = {};
  document.querySelectorAll(".cell[data-tile-id]").forEach(cell => {
    state[cell.id] = { tileId: cell.dataset.tileId };
  });

  const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "grid-state.json";
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById("importBtn").addEventListener("click", () => {
  document.getElementById("importFile").click();
});

document.getElementById("importFile").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const state = JSON.parse(e.target.result);

    // Clear grid
    document.querySelectorAll(".cell").forEach(cell => {
      delete cell.dataset.tileId;
      if (cell.firstChild?.tagName === "IMG") cell.firstChild.remove();
    });

    // Restore state
    for (const [cellId, data] of Object.entries(state)) {
      const cell = document.getElementById(cellId);
      if (cell) {
        placeTile(cell, `./images/${data.tileId}.png`, data.tileId, null);
      }
    }
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
